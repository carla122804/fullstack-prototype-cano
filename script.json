/*  DOM HELPER  */
const $ = id => document.getElementById(id);

/*  GLOBAL CONFIG  */
const STORAGE_KEY = 'ipt_demo_v1';
let currentUser = null;

/*  GLOBAL DATA STORE  */
window.db = {
  accounts: [],
  departments: [],
  employees: [],
  requests: []
};

/*  UPDATED STORAGE FUNCTIONS  */
function save(key, data) {
  // Update window.db based on key
  if (key === "users") window.db.accounts = data;
  if (key === "departments") window.db.departments = data;
  if (key === "employees") window.db.employees = data;
  if (key === "requests") window.db.requests = data;
  
  // Save to localStorage
  saveToStorage();
}

function load(key, defaultValue = []) {
  if (key === "users") return window.db.accounts.length > 0 ? window.db.accounts : defaultValue;
  if (key === "departments") return window.db.departments.length > 0 ? window.db.departments : defaultValue;
  if (key === "employees") return window.db.employees.length > 0 ? window.db.employees : defaultValue;
  if (key === "requests") return window.db.requests.length > 0 ? window.db.requests : defaultValue;
  if (key === "currentUser") return currentUser;
  return defaultValue;
}

function saveToStorage() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(window.db));
}

function loadFromStorage() {
  const data = localStorage.getItem(STORAGE_KEY);
  if (data) {
    try {
      window.db = JSON.parse(data);
    } catch (e) {
      initializeDefaultData();
    }
  } else {
    initializeDefaultData();
  }
}

function initializeDefaultData() {
  window.db = {
    accounts: [{
      id: 1,
      firstName: "Admin",
      lastName: "User",
      email: "admin@example.com",
      password: "admin123",
      role: "admin",
      isVerified: true
    }],
    departments: [
      { id: 1, name: "Engineering", desc: "Engineering Department" },
      { id: 2, name: "HR", desc: "Human Resources" },
      { id: 3, name: "Finance", desc: "Finance Department" },
      { id: 4, name: "IT", desc: "Information Technology" },
      { id: 5, name: "Accounting", desc: "Accounting Department" },
      { id: 6, name: "Marketing", desc: "Marketing Department" }
    ],
    employees: [],
    requests: []
  };
  saveToStorage();
}

function getCurrentUser() {
  return currentUser;
}

function setCurrentUser(user) {
  currentUser = user;
}

/*  TOAST NOTIFICATIONS  */
function showToast(message, type = 'info') {
  const colors = {
    'info': '#17a2b8',
    'success': '#28a745',
    'warning': '#ffc107',
    'danger': '#dc3545'
  };
  
  const textColor = type === 'warning' ? '#333' : 'white';
  
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 4px;
    color: ${textColor};
    background-color: ${colors[type]};
    font-weight: 500;
    z-index: 9999;
    animation: slideIn 0.3s ease-out;
  `;
  toast.textContent = message;
  
  document.body.appendChild(toast);
  
  setTimeout(() => toast.remove(), 3000);
}

/*  ADMIN SEED  */
function seedAdmin() {
  if (window.db.accounts.length === 0) {
    initializeDefaultData();
  }
}

/*  NAVIGATION */
function goToPage(name) {
  const adminPages = ["employees", "departments", "accounts"];
  let user = getCurrentUser();

  if (adminPages.includes(name) && (!user || user.role !== "admin")) {
    showToast("Admin access only", "danger");
    return;
  }

  document.querySelectorAll(".page").forEach(p => p.style.display = "none");
  $(name + "Page").style.display = "block";
  $("dropdownMenu").style.display = "none";

  if (name === "profile") loadProfile();
  if (name === "requests") loadRequests();
  if (name === "employees") {
    renderEmployeesTable();
  }
  if (name === "departments") loadDepartments();
  if (name === "accounts") loadAccounts();
}

/*  AUTH  */

function handleRegister() {
  let firstName = $("regFirstName").value.trim();
  let lastName = $("regLastName").value.trim();
  let email = $("regEmail").value.trim();
  let password = $("regPassword").value.trim();

  if (!firstName || !lastName || !email || !password) {
    showToast("Fill all fields", "warning");
    return;
  }

  let users = load("users");
  if (users.find(u => u.email === email)) {
    showToast("Email already exists", "danger");
    return;
  }

  users.push({
    id: Date.now(),
    firstName,
    lastName,
    email,
    password,
    role: "user",
    isVerified: false
  });

  save("users", users);
  showToast("Registration successful! Please verify your email.", "success");
  goToPage("verify");
}

function simulateVerification() {
  let users = load("users");
  let lastUser = users[users.length - 1];
  if (!lastUser) return;
  lastUser.isVerified = true;
  save("users", users);
  showToast("Email verified successfully!", "success");
  goToPage("login");
}

function handleLogin() {
  let email = $("loginEmail").value.trim();
  let password = $("loginPassword").value.trim();
  let users = load("users");

  let user = users.find(u => u.email === email && u.password === password);
  if (!user) {
    showToast("Invalid credentials", "danger");
    return;
  }
  if (!user.isVerified) {
    showToast("Verify your email first", "warning");
    return;
  }

  setCurrentUser(user);
  updateNavbar();
  showToast("Login successful!", "success");
  goToPage("profile");
}

function userLogout() {
  localStorage.removeItem("currentUser");
  setCurrentUser(null);
  updateNavbar();
  showToast("Logged out successfully", "success");
  goToPage("home");
}

/*  NAVBAR  */

function updateNavbar() {
  let user = getCurrentUser();
  if (user) {
    $("authLinks").style.display = "none";
    $("userDropdown").style.display = "block";
    $("usernameDisplay").textContent = user.firstName;
    $("adminLinks").style.display = user.role === "admin" ? "block" : "none";
  } else {
    $("authLinks").style.display = "flex";
    $("userDropdown").style.display = "none";
  }
}

function toggleDropdown() {
  let menu = $("dropdownMenu");
  menu.style.display = menu.style.display === "block" ? "none" : "block";
}

/*  PROFILE  */

function loadProfile() {
  let user = getCurrentUser();
  if (!user) return;
  $("profileName").textContent = user.firstName + " " + user.lastName;
  $("profileEmail").textContent = user.email;
  $("profileRole").textContent = user.role.toUpperCase();
}

function showEditProfileModal() {
  let user = getCurrentUser();
  if (!user) return;
  $("editFirstName").value = user.firstName;
  $("editLastName").value = user.lastName;
  $("editProfileModal").style.display = "block";
  $("editProfileOverlay").style.display = "block";
}

function closeEditProfileModal() {
  $("editProfileModal").style.display = "none";
  $("editProfileOverlay").style.display = "none";
}

function handleEditProfile() {
  let firstName = $("editFirstName").value.trim();
  let lastName = $("editLastName").value.trim();

  if (!firstName || !lastName) {
    showToast("Fill all fields", "warning");
    return;
  }

  if (currentUser) {
    currentUser.firstName = firstName;
    currentUser.lastName = lastName;
    
    let users = load("users");
    let user = users.find(u => u.id === currentUser.id);
    if (user) {
      user.firstName = firstName;
      user.lastName = lastName;
      save("users", users);
    }
    
    loadProfile();
    closeEditProfileModal();
    showToast("Profile updated successfully!", "success");
  }
}

/* REQUESTS  */

function showRequestModal() {
  $("reqType").value = "";
  initializeItemsList();
  $("requestModal").style.display = "block";
  $("modalOverlay").style.display = "block";
}

function closeRequestModal() {
  $("requestModal").style.display = "none";
  $("modalOverlay").style.display = "none";
  $("reqType").value = "";
  $("itemsList").innerHTML = "";
  $("requestModal").dataset.editingId = "";
}

function initializeItemsList() {
  $("itemsList").innerHTML = `
    <div class="item-row" style="display: flex; gap: 8px; margin-bottom: 10px; align-items: center;">
      <input type="text" class="item-name" placeholder="Item name" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
      <input type="number" class="item-qty" value="1" min="1" style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
      <button class="btn btn-success btn-sm" onclick="addItemField()" style="padding: 8px 12px;">+</button>
    </div>
  `;
}

function addItemField() {
  let itemsList = $("itemsList");
  let itemCount = itemsList.querySelectorAll(".item-row").length;
  
  let newRow = document.createElement("div");
  newRow.className = "item-row";
  newRow.style.cssText = "display: flex; gap: 8px; margin-bottom: 10px; align-items: center;";
  newRow.innerHTML = `
    <input type="text" class="item-name" placeholder="Item name" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
    <input type="number" class="item-qty" value="1" min="1" style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
    <button class="btn btn-danger btn-sm" onclick="removeItemField(this)" style="padding: 8px 12px;">×</button>
  `;
  itemsList.appendChild(newRow);
}

function removeItemField(button) {
  button.parentElement.remove();
}

function handleAddRequest() {
  let user = getCurrentUser();
  if (!user) {
    showToast("You must be logged in", "danger");
    return;
  }

  let type = $("reqType").value.trim();
  if (!type) {
    showToast("Select request type", "warning");
    return;
  }

  let itemRows = $("itemsList").querySelectorAll(".item-row");
  let items = [];

  itemRows.forEach(row => {
    let name = row.querySelector(".item-name").value.trim();
    let qty = parseInt(row.querySelector(".item-qty").value) || 1;
    
    if (name) {
      items.push({ name, quantity: qty });
    }
  });

  if (items.length === 0) {
    showToast("Add at least one item", "warning");
    return;
  }

  let requests = load("requests");
  let editingId = $("requestModal").dataset.editingId;

  if (editingId) {
    let request = requests.find(r => r.id === Number(editingId));
    if (request) {
      request.type = type;
      request.items = items;
      request.date = new Date().toLocaleDateString();
    }
  } else {
    requests.push({
      id: Date.now(),
      type,
      items,
      status: "Pending",
      date: new Date().toLocaleDateString(),
      employeeEmail: user.email
    });
  }

  save("requests", requests);
  closeRequestModal();
  loadRequests();
  showToast("Request saved successfully!", "success");
}

function loadRequests() {
  let user = getCurrentUser();
  if (!user) return;

  let requests = load("requests").filter(r => r.employeeEmail === user.email);

  if (requests.length === 0) {
    $("requestsList").innerHTML = `
      <p style="color: #999; margin: 20px 0;">You have no requests yet.</p>
      <button class="btn btn-success" onclick="showRequestModal()">Create One</button>
    `;
    return;
  }

  let statusBadges = {
    "Pending": "warning",
    "Approved": "success",
    "Rejected": "danger"
  };

  $("requestsList").innerHTML = `
    <table class="data-table">
      <thead>
        <tr>
          <th>Type</th>
          <th>Items</th>
          <th>Status</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${requests.map(r => `
          <tr>
            <td>${r.type}</td>
            <td>
              <ul style="margin: 0; padding-left: 20px;">
                ${r.items.map(item => `<li>${item.name} (x${item.quantity})</li>`).join("")}
              </ul>
            </td>
            <td>
              <span class="badge badge-${statusBadges[r.status]}">${r.status}</span>
            </td>
            <td>${r.date}</td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="editRequest(${r.id})">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteRequest(${r.id})">Delete</button>
            </td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}

function editRequest(id) {
  let requests = load("requests");
  let request = requests.find(r => r.id === id);
  if (!request) return;

  $("reqType").value = request.type;
  
  let itemsList = $("itemsList");
  itemsList.innerHTML = "";
  
  request.items.forEach((item, index) => {
    if (index === 0) {
      itemsList.innerHTML += `
        <div class="item-row" style="display: flex; gap: 8px; margin-bottom: 10px; align-items: center;">
          <input type="text" class="item-name" placeholder="Item name" value="${item.name}" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
          <input type="number" class="item-qty" value="${item.quantity}" min="1" style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
          <button class="btn btn-success btn-sm" onclick="addItemField()" style="padding: 8px 12px;">+</button>
        </div>
      `;
    } else {
      itemsList.innerHTML += `
        <div class="item-row" style="display: flex; gap: 8px; margin-bottom: 10px; align-items: center;">
          <input type="text" class="item-name" placeholder="Item name" value="${item.name}" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
          <input type="number" class="item-qty" value="${item.quantity}" min="1" style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
          <button class="btn btn-danger btn-sm" onclick="removeItemField(this)" style="padding: 8px 12px;">×</button>
        </div>
      `;
    }
  });

  $("requestModal").dataset.editingId = id;
  $("requestModal").style.display = "block";
  $("modalOverlay").style.display = "block";
}

function deleteRequest(id) {
  if (confirm("Are you sure you want to delete this request?")) {
    let requests = load("requests");
    save("requests", requests.filter(r => r.id !== id));
    loadRequests();
    showToast("Request deleted successfully!", "success");
  }
}

/*  EMPLOYEES  */

let editingEmployeeId = null;

function showEmployeeForm() { 
  clearEmployeeForm();
  $("empFormTitle").textContent = "Add Employee";
  
  let deptSelect = $("empDepartment");
  let depts = load("departments");
  
  deptSelect.innerHTML = '<option value="">-- Select Department --</option>';
  depts.forEach(d => {
    deptSelect.innerHTML += `<option value="${d.id}|${d.name}">${d.name}</option>`;
  });
  
  $("employeeForm").style.display = "block";
}

function hideEmployeeForm() { 
  $("employeeForm").style.display = "none";
  clearEmployeeForm();
}

function clearEmployeeForm() {
  $("empID").value = "";
  $("empEmail").value = "";
  $("empPosition").value = "";
  $("empDepartment").value = "";
  $("empHireDate").value = "";
  editingEmployeeId = null;
}

function handleAddEmployee() {
  let empID = $("empID").value.trim();
  let empEmail = $("empEmail").value.trim();
  let position = $("empPosition").value.trim();
  let deptData = $("empDepartment").value;
  let hireDate = $("empHireDate").value;

  if (!empID || !empEmail || !position || !deptData || !hireDate) {
    showToast("Fill all fields", "warning");
    return;
  }

  let users = load("users");
  let user = users.find(u => u.email === empEmail);
  
  if (!user) {
    showToast("User email does not exist. Please create the account first.", "danger");
    return;
  }

  let [deptID, deptName] = deptData.split("|");
  let employees = load("employees");

  if (editingEmployeeId) {
    let emp = employees.find(e => e.id === editingEmployeeId);
    if (!emp) return;

    if (empID !== emp.employeeID && employees.find(e => e.employeeID === empID)) {
      showToast("Employee ID already exists", "danger");
      return;
    }

    emp.employeeID = empID;
    emp.userID = user.id;
    emp.userEmail = empEmail;
    emp.position = position;
    emp.deptID = Number(deptID);
    emp.deptName = deptName;
    emp.hireDate = hireDate;
  } else {
    if (employees.find(e => e.employeeID === empID)) {
      showToast("Employee ID already exists", "danger");
      return;
    }

    employees.push({
      id: Date.now(),
      employeeID: empID,
      userID: user.id,
      userEmail: empEmail,
      position,
      deptID: Number(deptID),
      deptName,
      hireDate
    });
  }

  save("employees", employees);
  hideEmployeeForm();
  renderEmployeesTable();
  showToast("Employee saved successfully!", "success");
}

function editEmployee(id) {
  let employees = load("employees");
  let emp = employees.find(e => e.id === id);
  if (!emp) return;

  clearEmployeeForm();
  $("empFormTitle").textContent = "Edit Employee";
  
  $("empID").value = emp.employeeID;
  $("empEmail").value = emp.userEmail;
  $("empPosition").value = emp.position;
  $("empHireDate").value = emp.hireDate;
  
  let deptSelect = $("empDepartment");
  let depts = load("departments");
  
  deptSelect.innerHTML = '<option value="">-- Select Department --</option>';
  depts.forEach(d => {
    let selected = d.id === emp.deptID ? "selected" : "";
    deptSelect.innerHTML += `<option value="${d.id}|${d.name}" ${selected}>${d.name}</option>`;
  });
  
  editingEmployeeId = id;
  $("employeeForm").style.display = "block";
}

function renderEmployeesTable() {
  let employees = load("employees");

  $("employeesTable").innerHTML = employees.length
    ? employees.map(e => `
      <tr>
        <td>${e.employeeID}</td>
        <td>${e.userEmail}</td>
        <td>${e.position}</td>
        <td>${e.deptName}</td>
        <td>
          <button class="btn btn-primary btn-sm"
            onclick="editEmployee(${e.id})">Edit</button>
          <button class="btn btn-danger btn-sm"
            onclick="deleteEmployee(${e.id})">Delete</button>
        </td>
      </tr>`).join("")
    : '<tr><td colspan="5" style="text-align: center;">No employees</td></tr>';
}

function deleteEmployee(id) {
  if (confirm("Are you sure you want to delete this employee?")) {
    let employees = load("employees");
    save("employees", employees.filter(e => e.id !== id));
    renderEmployeesTable();
    showToast("Employee deleted successfully!", "success");
  }
}

/*  DEPARTMENTS  */

let editingDeptId = null;

function showDepartmentForm() {
  $("departmentForm").style.display = "block";
}

function hideDepartmentForm() {
  $("departmentForm").style.display = "none";
  $("deptName").value = "";
  $("deptDesc").value = "";
  editingDeptId = null;
}

function handleAddDepartment() {
  let name = $("deptName").value.trim();
  let desc = $("deptDesc").value.trim();
  if (!name || !desc) {
    showToast("Fill all fields", "warning");
    return;
  }

  let depts = load("departments");

  if (editingDeptId) {
    let d = depts.find(x => x.id === editingDeptId);
    d.name = name;
    d.desc = desc;
  } else {
    depts.push({ id: Date.now(), name, desc });
  }

  save("departments", depts);
  hideDepartmentForm();
  loadDepartments();
  showToast("Department saved successfully!", "success");
}

function editDepartment(id) {
  let dept = load("departments").find(d => d.id === id);
  if (!dept) return;

  $("deptName").value = dept.name;
  $("deptDesc").value = dept.desc;
  editingDeptId = id;
  showDepartmentForm();
}

function loadDepartments() {
  let depts = load("departments");

  $("departmentsTable").innerHTML = depts.length
    ? depts.map(d => `
      <tr>
        <td>${d.name}</td>
        <td>${d.desc}</td>
        <td>
          <button class="btn btn-primary btn-sm"
            onclick="editDepartment(${d.id})">Edit</button>
          <button class="btn btn-danger btn-sm"
            onclick="deleteDepartment(${d.id})">Delete</button>
        </td>
      </tr>`).join("")
    : '<tr><td colspan="3" style="text-align: center;">No departments</td></tr>';
}

function deleteDepartment(id) {
  let depts = load("departments");
  save("departments", depts.filter(d => d.id !== id));
  loadDepartments();
  showToast("Department deleted successfully!", "success");
}

/*  ACCOUNTS  */

function showAddAccountForm() {
  $("addAccountForm").style.display = "block";
  $("accFirstName").value = "";
  $("accLastName").value = "";
  $("accEmail").value = "";
  $("accPassword").value = "";
  $("accRole").value = "user";
  $("accVerified").checked = false;
}

function hideAddAccountForm() {
  $("addAccountForm").style.display = "none";
  $("accFirstName").value = "";
  $("accLastName").value = "";
  $("accEmail").value = "";
  $("accPassword").value = "";
  $("accRole").value = "user";
  $("accVerified").checked = false;
  $("addAccountForm").dataset.editingId = "";
}

function handleAddAccount() {
  let firstName = $("accFirstName").value.trim();
  let lastName = $("accLastName").value.trim();
  let email = $("accEmail").value.trim();
  let password = $("accPassword").value.trim();
  let role = $("accRole").value;
  let isVerified = $("accVerified").checked;
  let editingId = $("addAccountForm").dataset.editingId;

  if (!firstName || !lastName || !email) {
    showToast("Fill all fields", "warning");
    return;
  }

  let users = load("users");

  if (editingId) {
    let user = users.find(u => u.id === Number(editingId));
    if (!user) return;

    if (email !== user.email && users.find(u => u.email === email)) {
      showToast("Email already exists", "danger");
      return;
    }

    user.firstName = firstName;
    user.lastName = lastName;
    user.email = email;
    if (password) user.password = password;
    user.role = role;
    user.isVerified = isVerified;
  } else {
    if (!password) {
      showToast("Password is required for new accounts", "warning");
      return;
    }

    if (users.find(u => u.email === email)) {
      showToast("Email already exists", "danger");
      return;
    }

    users.push({
      id: Date.now(),
      firstName,
      lastName,
      email,
      password,
      role,
      isVerified
    });
  }

  save("users", users);
  hideAddAccountForm();
  loadAccounts();
  showToast("Account saved successfully!", "success");
}

function loadAccounts() {
  let accounts = load("users");

  $("accountsTable").innerHTML = accounts.length
    ? accounts.map(u => `
      <tr>
        <td>${u.firstName} ${u.lastName}</td>
        <td>${u.email}</td>
        <td>${u.role}</td>
        <td>
          <span style="color: ${u.isVerified ? '#28a745' : '#dc3545'}; font-size: 18px;">
            ${u.isVerified ? '✓' : ''}
          </span>
        </td>
        <td>
          <button class="btn btn-primary btn-sm"
            onclick="editAccount(${u.id})">Edit</button>
          <button class="btn btn-warning btn-sm"
            onclick="resetPassword(${u.id})">Reset Password</button>
          <button class="btn btn-danger btn-sm"
            onclick="deleteAccount(${u.id})">Delete</button>
        </td>
      </tr>`).join("")
    : '<tr><td colspan="5" style="text-align: center;">No accounts</td></tr>';
}

function deleteAccount(id) {
  let users = load("users");
  let currentUser = getCurrentUser();
  
  if (currentUser && currentUser.id === id) {
    showToast("Cannot delete your own account while logged in", "danger");
    return;
  }

  if (confirm("Are you sure you want to delete this account?")) {
    save("users", users.filter(u => u.id !== id));
    loadAccounts();
    showToast("Account deleted successfully!", "success");
  }
}

function editAccount(id) {
  let users = load("users");
  let user = users.find(u => u.id === id);
  if (!user) return;

  $("accFirstName").value = user.firstName;
  $("accLastName").value = user.lastName;
  $("accEmail").value = user.email;
  $("accPassword").value = "";
  $("accRole").value = user.role;
  $("accVerified").checked = user.isVerified;
  
  $("addAccountForm").dataset.editingId = id;
  $("addAccountForm").style.display = "block";
}

function resetPassword(id) {
  let users = load("users");
  let user = users.find(u => u.id === id);
  if (!user) return;

  let newPassword = prompt(`Enter new password for ${user.email}:`);
  if (newPassword === null) return;
  
  if (newPassword.trim() === "") {
    showToast("Password cannot be empty", "warning");
    return;
  }

  user.password = newPassword.trim();
  save("users", users);
  showToast("Password reset successfully!", "success");
  loadAccounts();
}

/*  INITIALIZATION  */

window.addEventListener("DOMContentLoaded", () => {
  loadFromStorage();
  seedAdmin();
  updateNavbar();
  goToPage("home");
});
